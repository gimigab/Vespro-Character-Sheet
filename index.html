<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scheda — Vespro Cantatuono</title>
<style>
:root{
  --paper:#f7ead3;
  --ink:#2b1206;
  --accent:#b84b1a;
  --muted:#7a5a47;
  --panel: #fff6e8;
  --green:#9fdc8c;
}
html,body{height:100%;margin:0;font-family: "Georgia", serif;background:linear-gradient(#efe0c8,#f9efd9);color:var(--ink);}
.container{max-width:980px;margin:18px auto;padding:18px;background:var(--paper);box-shadow:0 6px 30px rgba(0,0,0,0.12);border-radius:12px;border:2px solid rgba(160,110,60,0.12)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.title{font-size:26px;color:var(--accent);margin:0}
.subtitle{font-size:13px;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center}
.card{background:var(--panel);border-radius:8px;padding:10px;border:1px solid rgba(0,0,0,0.06);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
.left{flex:1;min-width:260px}
.right{min-width:260px}
.section{margin-top:14px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.stat{background:linear-gradient(180deg,#fff8ea,#fff2d9);padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);text-align:center;cursor:pointer}
.stat h3{margin:0;font-size:14px}
.stat .num{font-size:22px;font-weight:700}
.inline-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:white;cursor:pointer}
.big{font-size:18px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.counter{display:flex;align-items:center;gap:8px}
.spells{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.spell-card{background:#fff6e8;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);text-align:center}
.footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:40}
.modal .box{width:94%;max-width:520px;background:var(--paper);padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)}
.skill-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(0,0,0,0.02);margin-bottom:6px}
.btn-close{float:right;background:transparent;border:0;font-weight:700;cursor:pointer;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
kbd{background:#fff;padding:4px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
.tiny{font-size:12px;color:var(--muted)}
@media(max-width:720px){.grid3{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <div>
        <h1 class="title"> Vespro Cantatuono</h1>
        <div class="subtitle"> Gnomo delle Maree — Stregone Bronzeo </div>
      </div>
      <div class="card right">
        <div class="small">Livello</div>
        <div class="flex" style="align-items:center">
          <button class="inline-btn" id="lvlMinus">-</button>
          <div class="big" id="lvl">1</div>
          <button class="inline-btn" id="lvlPlus">+</button>
        </div>
        <div style="height:8px"></div>
        <div class="small">Bonus competenza</div>
        <div class="flex">
          <button class="inline-btn" id="profMinus">-</button>
          <div class="big" id="prof">+2</div>
          <button class="inline-btn" id="profPlus">+</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="grid3" id="statsGrid"></div>
      <div class="tiny" style="margin-top:8px">Clicca su una statistica per aprire le abilità e i tiri salvezza.</div>
    </div>

    <div class="section" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <div class="card left">

        <!-- PF MASSIMI -->
        <div class="small">PF Massimi</div>
        <div class="flex">
          <button class="inline-btn" id="hpMaxMinus">-</button>
          <div class="big" id="hpMax">9</div>
          <button class="inline-btn" id="hpMaxPlus">+</button>
        </div>

        <div style="height:8px"></div>

        <!-- PF ATTUALI -->
        <div class="small">PF Attuali</div>
        <div class="flex">
          <button class="inline-btn" id="hpMinus">-</button>
          <div class="big" id="hpCur">9</div>
          <button class="inline-btn" id="hpPlus">+</button>
        </div>

        <div style="height:8px"></div>

        <!-- PF EXTRA -->
        <div class="small">PF Extra</div>
        <div class="flex">
          <button class="inline-btn" id="thpMinus">-</button>
          <div class="big" id="thp">0</div>
          <button class="inline-btn" id="thpPlus">+</button>
        </div>

        <div style="height:12px"></div>

        <!-- AC -->
        <div class="small">Classe Armatura</div>
        <div class="flex">
          <button class="inline-btn" id="acMinus">-</button>
          <div class="big" id="ac">10</div>
          <button class="inline-btn" id="acPlus">+</button>
        </div>

        <div style="height:12px"></div>

        <!-- ✨ Metamagia (di Classe) -->
        <div class="small">Metamagia</div>
        <div class="flex">
          <button class="inline-btn" id="wildMinus">-</button>
          <div class="big" id="wild">2</div>
          <button class="inline-btn" id="wildPlus">+</button>
        </div>

        <div style="height:12px"></div>

        <!-- ISPIRAZIONE -->
        <div class="small">Ispirazione</div>
        <div class="flex">
          <button class="inline-btn" id="inspMinus">-</button>
          <div class="big" id="insp">0</div>
          <button class="inline-btn" id="inspPlus">+</button>
        </div>

        <div style="height:12px"></div>

        <!-- TIRI SALVEZZA MORTE -->
        <div class="small">Tiri Salvezza Morte</div>
        <div class="tiny">Successi: <span id="deathSucc">0</span> • Fallimenti: <span id="deathFail">0</span></div>
        <div style="margin-top:6px" class="controls">
          <button class="inline-btn" id="deathSuccPlus">+S</button>
          <button class="inline-btn" id="deathSuccMinus">-S</button>
          <button class="inline-btn" id="deathFailPlus">+F</button>
          <button class="inline-btn" id="deathFailMinus">-F</button>
        </div>

      </div>

      <!-- INCANTESIMI -->
      <div class="card right" style="min-width:300px">
        <div class="small">Slot Incantesimi</div>
        <div class="spells" id="spellSlots" style="margin-top:8px"></div>

        <div class="controls" style="margin-top:10px">
          <button id="resetSlots" class="inline-btn">Reset slot</button>
          <button id="exportBtn" class="inline-btn">Esporta JSON</button>
          <button id="importBtn" class="inline-btn">Importa JSON</button>
          <input type="file" id="importFile" style="display:none" accept="application/json">
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="tiny">Salvataggio automatico locale (localStorage).</div>
      <div class="tiny">Puoi aggiungere la pagina alla schermata Home su iPhone per usarla come app.</div>
    </div>
  </div>

  <!-- MODALE -->
  <div class="modal" id="modal">
    <div class="box" id="modalBox">
      <button class="btn-close" id="modalClose">Chiudi ✕</button>
      <h2 id="modalTitle"></h2>
      <div class="tiny" id="modalSub"></div>
      <hr style="margin:8px 0">
      <div id="modalContent"></div>
      <div style="height:10px"></div>
      <div style="text-align:right">
        <button id="modalSave" class="inline-btn">Chiudi</button>
      </div>
    </div>
  </div>

<script>
/* DATI INIZIALI */
const initial = {
  nome: "Vespro Cantatuono",
  classe: "Stregone Bronzeo",
  livello: 1,
  profBonus: 2,
  stats: { Forza:8, Destrezza:14, Costituzione:14, Intelligenza:12, Saggezza:10, Carisma:16 },
  hpMax:9, hpCur:9, thp:0, ac:10, wild:2, inspiration:0,
  slots:{1:2,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0},
  profs:{},
  death:{succ:0,fail:0}
};

const SAVE_KEY="scheda_vespro";
function mod(s){return Math.floor((s-10)/2);}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function save(){localStorage.setItem(SAVE_KEY,JSON.stringify(state));}
function load(){const r=localStorage.getItem(SAVE_KEY);if(!r)return JSON.parse(JSON.stringify(initial));try{return JSON.parse(r);}catch{return JSON.parse(JSON.stringify(initial));}}
let state=load();

const skillMap={
  Forza:["Atletica"],
  Destrezza:["Acrobazia","Furtività","Rapidità di Mano"],
  Costituzione:[],
  Intelligenza:["Arcano","Indagare","Natura","Storia","Religione"],
  Saggezza:["Medicina","Percezione","Sopravvivenza","Intuizione","Addestrare Animali"],
  Carisma:["Inganno","Intimidire","Persuasione","Intrattenere"]
};

const el=id=>document.getElementById(id);
let currentStatInModal=null;

function renderAll(){
  el("lvl").textContent=state.livello;
  el("prof").textContent=(state.profBonus>=0?"+":"")+state.profBonus;

  const g=el("statsGrid"); g.innerHTML="";
  for(const[n,v] of Object.entries(state.stats)){
    const m=mod(v);
    const d=document.createElement("div");
    d.className="stat";
    d.innerHTML=`<h3>${n}</h3><div class="num">${v}</div><div class="small">Mod ${m>=0?"+":""}${m}</div>`;
    d.onclick=()=>{currentStatInModal=n;openModal(n);};
    g.appendChild(d);
  }

  el("hpMax").textContent=state.hpMax;
  el("hpCur").textContent=state.hpCur;
  el("thp").textContent=state.thp;
  el("ac").textContent=state.ac;
  el("insp").textContent=state.inspiration;
  el("wild").textContent=state.wild;

  el("deathSucc").textContent=state.death.succ;
  el("deathFail").textContent=state.death.fail;

  const slotsDiv=el("spellSlots"); slotsDiv.innerHTML="";
  for(let i=1;i<=9;i++){
    const val=state.slots[i]||0;
    const c=document.createElement("div");
    c.className="spell-card";
    c.innerHTML=`
      <div class="small">Livello ${i}</div>
      <div class="flex" style="justify-content:center;align-items:center;margin-top:6px">
        <button class="inline-btn" data-l="${i}" data-op="-" onclick="slotChange(event)">-</button>
        <div style="width:36px;text-align:center;font-weight:700">${val}</div>
        <button class="inline-btn" data-l="${i}" data-op="+" onclick="slotChange(event)">+</button>
      </div>`;
    slotsDiv.appendChild(c);
  }

  save();
}

/* ✨ MODIFICHE RICHIESTE ✨ */
function askAmount(msg){
  let v=prompt(msg);
  if(v===null) return null;
  v=parseInt(v);
  return isNaN(v)?null:v;
}

/* PF MASSIMI */
el("hpMaxPlus").onclick=()=>{
  let a=askAmount("Aumentare PF Massimi di quanto?");
  if(a!=null && a>0){
    state.hpMax+=a;
    state.hpCur=Math.min(state.hpCur,state.hpMax);
    renderAll();
  }
};
el("hpMaxMinus").onclick=()=>{
  let a=askAmount("Diminuire PF Massimi di quanto?");
  if(a!=null && a>0){
    state.hpMax=Math.max(1,state.hpMax-a);
    state.hpCur=Math.min(state.hpCur,state.hpMax);
    renderAll();
  }
};

/* PF ATTUALI */
el("hpPlus").onclick=()=>{
  let a=askAmount("Aumentare PF Attuali di quanto?");
  if(a!=null && a>0){
    state.hpCur=Math.min(state.hpMax,state.hpCur+a);
    renderAll();
  }
};
el("hpMinus").onclick=()=>{
  let a=askAmount("Diminuire PF Attuali di quanto?");
  if(a!=null && a>0){
    state.hpCur=Math.max(0,state.hpCur-a);
    renderAll();
  }
};

/* PF EXTRA */
el("thpPlus").onclick=()=>{
  let a=askAmount("Aumentare PF Extra di quanto?");
  if(a!=null && a>0){
    state.thp+=a;
    renderAll();
  }
};
el("thpMinus").onclick=()=>{
  let a=askAmount("Diminuire PF Extra di quanto?");
  if(a!=null && a>0){
    state.thp=Math.max(0,state.thp-a);
    renderAll();
  }
};

/* RESTO IDENTICO */
el("lvlPlus").onclick=()=>{state.livello++;renderAll();};
el("lvlMinus").onclick=()=>{state.livello=Math.max(1,state.livello-1);renderAll();};

el("profPlus").onclick=()=>{state.profBonus++;renderAll();};
el("profMinus").onclick=()=>{state.profBonus=Math.max(0,state.profBonus-1);renderAll();};

el("acPlus").onclick=()=>{state.ac++;renderAll();};
el("acMinus").onclick=()=>{state.ac=Math.max(0,state.ac-1);renderAll();};

el("inspPlus").onclick=()=>{state.inspiration++;renderAll();};
el("inspMinus").onclick=()=>{state.inspiration=Math.max(0,state.inspiration-1);renderAll();};

el("wildPlus").onclick=()=>{state.wild++;renderAll();};
el("wildMinus").onclick=()=>{state.wild=Math.max(0,state.wild-1);renderAll();};

el("deathSuccPlus").onclick=()=>{state.death.succ=clamp(state.death.succ+1,0,3);renderAll();};
el("deathSuccMinus").onclick=()=>{state.death.succ=clamp(state.death.succ-1,0,3);renderAll();};
el("deathFailPlus").onclick=()=>{state.death.fail=clamp(state.death.fail+1,0,3);renderAll();};
el("deathFailMinus").onclick=()=>{state.death.fail=clamp(state.death.fail-1,0,3);renderAll();};

function slotChange(e){
  const lvl=Number(e.currentTarget.dataset.l);
  const op=e.currentTarget.dataset.op;
  if(op==="+") state.slots[lvl]=(state.slots[lvl]||0)+1;
  else state.slots[lvl]=Math.max(0,(state.slots[lvl]||0)-1);
  renderAll();
}

el("resetSlots").onclick=()=>{
  if(confirm("Ripristinare gli slot ai valori iniziali?")){
    state.slots=Object.assign({},initial.slots);
    renderAll();
  }
};

el("exportBtn").onclick=()=>{
  const data="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state,null,2));
  const a=document.createElement("a");
  a.href=data; a.download="scheda_vespro.json";
  document.body.appendChild(a); a.click(); a.remove();
};
el("importBtn").onclick=()=>el("importFile").click();
el("importFile").addEventListener("change",(ev)=>{
  const f=ev.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      state=Object.assign({},initial,JSON.parse(r.result));
      renderAll();
      alert("Import riuscito");
    }catch(e){alert("File non valido");}
  };
  r.readAsText(f);
});

/* MODALE */
const modal=el("modal");
const modalTitle=el("modalTitle");
const modalSub=el("modalSub");
const modalContent=el("modalContent");

function computeSkillValue(key,isSave){
  if(isSave){
    const base=mod(state.stats[key]);
    const p=state.profs[key+"_save"]?state.profBonus:0;
    return base+p;
  }else{
    for(const[s,list]of Object.entries(skillMap)){
      if(list.includes(key)){
        const base=mod(state.stats[s]);
        const p=state.profs[key]?state.profBonus:0;
        return base+p;
      }
    }
    return 0;
  }
}

function toggleProf(key){
  state.profs[key]=!state.profs[key];
  save(); renderAll();
  if(currentStatInModal)openModal(currentStatInModal);
}

function openModal(stat){
  modal.style.display="flex";
  modalTitle.textContent=stat;
  const score=state.stats[stat];
  const m=mod(score);
  modalSub.textContent=`Valore: ${score} • Modificatore: ${m>=0?"+":""}${m}`;

  modalContent.innerHTML="";

  const saveRow=document.createElement("div");
  saveRow.className="skill-row";
  const keySave=stat+"_save";
  const saveVal=computeSkillValue(stat,true);

  saveRow.innerHTML=`
    <div>Tiro Salvezza</div>
    <div>
      <span style="margin-right:8px">${saveVal>=0?"+":""}${saveVal}</span>
      <button class="inline-btn" onclick="toggleProf('${keySave}')">
        ${state.profs[keySave]?"P ✓":"Aggiungi P"}
      </button>
    </div>`;
  modalContent.appendChild(saveRow);

  modalContent.appendChild(document.createElement("hr"));

  for(const sk of skillMap[stat]||[]){
    const v=computeSkillValue(sk,false);
    const row=document.createElement("div");
    row.className="skill-row";
    row.innerHTML=`
      <div>${sk}</div>
      <div>
        <span style="margin-right:8px">${v>=0?"+":""}${v}</span>
        <button class="inline-btn" onclick="toggleProf('${sk}')">
          ${state.profs[sk]?"P ✓":"Aggiungi P"}
        </button>
      </div>`;
    modalContent.appendChild(row);
  }

  modalContent.appendChild(document.createElement("hr"));

  const edit=document.createElement("div");
  edit.innerHTML=`
    <div class="tiny">
      Modifica valore ${stat}:
      <input id="statEdit" type="number" value="${score}" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)">
      <button class="inline-btn" onclick="saveStat('${stat}')">Salva</button>
    </div>`;
  modalContent.appendChild(edit);
}

function saveStat(stat){
  const v=parseInt(el("statEdit").value);
  state.stats[stat]=clamp(v,1,30);
  renderAll();
  openModal(stat);
}

function closeModal(){modal.style.display="none";}
el("modalClose").onclick=closeModal;
el("modalSave").onclick=closeModal;
modal.onclick=e=>{if(e.target===modal)closeModal();};

function init(){
  state.stats=Object.assign({},initial.stats,state.stats||{});
  state.slots=Object.assign({},initial.slots,state.slots||{});
  state.profs=Object.assign({},state.profs||{});
  if(state.wild==null) state.wild=2;
  renderAll();
}

init();
// autosave sicurezza mobile
window.addEventListener("beforeunload", save);
window.addEventListener("pagehide", save);
window.addEventListener("visibilitychange", ()=>{
  if(document.hidden) save();
});

// salva ogni 5 secondi
setInterval(save, 5000);

</script>
</body>
</html>